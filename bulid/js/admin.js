$(function(){function refreshTable(){$.ajax({url:"src/sever/getNews.php",type:"GET",dataTypes:"json",data:{newstype:""},success:function(response){var tbody=$("#newstable tbody"),data=eval("("+response+")");data.forEach(function(e,t){var a=$("<tr></tr>"),n=$("<td></td>").html(data[t].newstype),s=$("<td></td>").html(data[t].newstitle),l=$("<td></td>").html(data[t].newstime),o=$("<td></td>").html(data[t].newshot),r=$("<td></td>"),i=$('<button type="button" class="btn btn-primary btn-xs">编辑</button>'),p=$('<button type="button" class="btn btn-danger btn-xs">删除</button>');r.append(i).append(p),a.append(n).append(s).append(l).append(o).append(r),tbody.prepend(a)})},error:function(e){console.log(e)}})}refreshTable(),$.ajax({url:"src/sever/getsubscribelist.php",type:"GET",dataTypes:"json",success:function(e){var t=$("#newstype");$.each(e,function(a,n){var s=$("<option></option>");s.html(e[a].listvalue),t.append(s)})},error:function(e){console.log(e)}}),$("#submitnews").on("click",function(e){e.preventDefault();if(function(){for(var e=0,t=$("#add_news input"),a=t.size(),n=$("#flag").val(),s=$("#newsimg"),l=0;l<a;l++)t.eq(l).val()?t.eq(l).parent().removeClass("has-error"):(e+=1,t.eq(l).parent().addClass("has-error"),"文字新闻"==n&&s.parent().removeClass("has-error"));if(0==e)return!0;var o=""!=$("#newstitle").val()&&""!=$("#newssrc").val()&&""!=$("#newstime").val()&&""!=$("#newshot").val();return!("文字新闻"!=$("#flag").val()||!o)}()){var t={newstype:$("#newstype").val(),newstitle:$("#newstitle").val(),flag:"多图新闻"==$("#flag").val()?1:"文字新闻"==$("#flag").val()?2:0,newssrc:$("#newssrc").val(),newstime:$("#newstime").val(),newshot:$("#newshot").val(),newsimg:$("#newsimg").val()};$.ajax({url:"src/sever/addnews.php",type:"POST",dataTypes:"json",data:{newNews:JSON.stringify(t)},success:function(e){$("#newstable tbody").empty(),$("#add_news input").val(""),$("#newstype").val("推荐"),$("#flag").val("单图新闻"),refreshTable()}})}}),$("#newstable tbody").on("click",".btn-danger",function(){$("#del_news_title").remove();var e=$(this).parent().prevAll().eq(2).html(),t=$('<p id="del_news_title"></p>');t.html(e),$("#deleteModal .modal-body").append(t),$("#deleteModal").modal("show")}),$("#confirmDelete").on("click",function(){$.ajax({url:"src/sever/deletenews.php",type:"POST",data:{del_news_title:$("#del_news_title").html()},success:function(e){$("#deleteModal").modal("hide"),$("#newstable tbody").empty(),refreshTable()},error:function(e){console.log(e)}})});var newsid=null;$("#newstable tbody").on("click",".btn-primary",function(){var _this=$(this);$.ajax({url:"src/sever/getsubscribelist.php",type:"GET",dataTypes:"json",success:function(e){var t=$("#unewstype");$.each(e,function(a,n){var s=$("<option></option>");s.html(e[a].listvalue),t.append(s)})},error:function(e){console.log(e)}}),$.ajax({url:"src/sever/getNews.php",type:"GET",dataTypes:"json",data:{newstype:""},success:function(response){var updatelist=null,originaltitle=_this.parent().prevAll().eq(2).html(),optionValue=null,data=eval("("+response+")");$.each(data,function(e,t){if(data[e].newstitle==originaltitle)return updatelist=data[e],!1}),optionValue=$("#uflag").children().eq(updatelist.flag).val(),$("#unewstype").val(updatelist.newstype),$("#unewstitle").val(updatelist.newstitle),$("#uflag").val(optionValue),$("#unewssrc").val(updatelist.newssrc),$("#unewstime").val(updatelist.newstime),$("#unewshot").val(updatelist.newshot),$("#unewsimg").val(updatelist.newsimg),newsid=updatelist.id},error:function(e){console.log(e)}}),$("#updateModal").modal("show")}),$("#updatenews").on("click",function(){var e={newstype:$("#unewstype").val(),newstitle:$("#unewstitle").val(),flag:"多图新闻"==$("#uflag").val()?1:"文字新闻"==$("#flag").val()?2:0,newssrc:$("#unewssrc").val(),newstime:$("#unewstime").val(),newshot:$("#unewshot").val(),newsimg:$("#unewsimg").val(),newsid:newsid};$.ajax({url:"src/sever/updatenews.php",type:"POST",data:{update:JSON.stringify(e)},success:function(e){$("#updateModal").modal("hide"),$("#newstable tbody").empty(),refreshTable()},error:function(e){console.log(e)}})}),$(".datetimepicker").datetimepicker({language:"zh-CN",format:"yyyy-mm-dd",autoclose:!0,minView:2,weekStart:0})});