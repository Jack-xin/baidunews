$(function(){function getMenus(){return new Promise(function(e,t){$.ajax({url:"src/sever/getsubscribelist.php",type:"GET",dataTypes:"json",success:function(t){e(t)},error:function(e,t,s){console.log(e.status),console.log(e.readyState),console.log(t)}})})}function calculatedMenusSize(){return new Promise(function(e,t){e()})}function switchNews(e){$("#newslist-container").empty(),$("#carousel").empty(),$(".hot-scroll-news").empty(),"推荐"==e?$(".hot-scroll-news").show():$(".hot-scroll-news").hide(),$(".ui-refresh").eq(0).hide(),$(".ui-refresh").eq(1).hide(),page=1,refresh(e)}function loadMore(e){var t=$(".g-hd").height(),s=Math.ceil(document.body.scrollTop+window.innerHeight),n=$(".wrapper").height();null==e&&(e="推荐"),finished&&n==s-t+1?(finished=!1,$(".ui-refresh").eq(0).show(),$(".ui-refresh").eq(1).hide(),refreshNews(e)):($(".ui-refresh").eq(0).hide(),$(".ui-refresh").eq(1).show())}function refresh(type){$.ajax({url:"src/sever/getcarousel.php",type:"GET",dataTypes:"json",data:{carouseltype:null==type?"":type},beforeSend:function(){var e=$("body").width(),t=window.innerHeight,s=$(".g-hd").height();$(".loadingNews").show().css({left:e/2,top:t/2-s})},success:function(response){$(".loadingNews").hide();var data=eval("("+response+")");createCarousel(data);var deviceWidth=$("body").width(),item=$(".carousel-item"),wrapper=$(".carousel"),contents=$(".carousel-content"),content=$(".carousel-content")[0],navItem=$(".carousel-nav-item"),images=$(".carousel-content img"),height=0;item.width(deviceWidth),contents.width(item.width()*item.length),height=getBigHeight(images),$(".carousel-item div").height(height-10);var u=navigator.userAgent,isAndroid=u.indexOf("Android")>-1||u.indexOf("Adr")>-1,isiOS=!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);isAndroid&&(contents.addClass("fixC"),item.addClass("fixI"));var carousel=new Carousel({wrapper:wrapper,content:content,item:item,navItem:navItem,itemWidth:deviceWidth});carousel._cssTransform(content,"translateX",0),carousel._play(),carousel.touchStart(),carousel.touchMove(),carousel.touchEnd(),refreshNews(type),refreshHot("hide")},error:function(e,t,s){console.log(e.status),console.log(e.readyState),console.log(t)}})}function refreshNews(type){$.ajax({url:"src/sever/getNews.php",type:"GET",dataTypes:"json",data:{newstype:null==type?"":type,page:page},success:function(response){var newsLength=response.substring(0,response.indexOf("[")),newsdata=response.substring(response.indexOf("[")),data=eval("("+newsdata+")");page>newsLength?page=Number(newsLength)+1:page++,data.forEach(function(e,t){var s=data[t].newsimg.split(",");0==s.length?createNewsContainer(data[t].newstype,data[t].newstitle,s,data[t].newstime,data[t].newshot,data[t].newssrc,data[t].flag):(s.length,createNewsContainer(data[t].newstype,data[t].newstitle,s,data[t].newstime,data[t].newshot,data[t].newssrc,data[t].flag))}),finished=!0},error:function(e,t,s){console.log(e.status),console.log(e.readyState),console.log(t)}})}function refreshHot(type){$.ajax({url:"src/sever/getHot.php",type:"GET",dataTypes:"json",data:{hottype:null==type?"":type},success:function(response){var data=eval("("+response+")");createScrollNews(data),scrollHot()},error:function(e,t,s){console.log(e.status),console.log(e.readyState),console.log(t)}})}function createCarousel(e){var t=$('<div class="carousel-content"></div>'),s=$('<div class="carousel-nav"></div>');$.each(e,function(n,a){var o=$('<div class="carousel-item"></div>'),r=$('<a href="'+e[n].carouselsrc+'">'),i=$("<div></div>"),l=$('<img src="'+e[n].carouselimg+'">'),c=$('<p class="option-text">'+e[n].carouseltitle+"</p>");i.append(l),r.append(i).append(c),o.append(r),t.append(o),s.append('<span class="carousel-nav-item"></span>')}),$(".carousel").append(t).append(s),$(".carousel-nav-item").eq(0).addClass("active"),$(".carousel-content").append($(".carousel-item").clone(!0))}function createNewsContainer(e,t,s,n,a,o,r){var i=$('<div class="index-list-container"></div>'),l=$('<div class="index-list-main"></div>'),c=$('<div class="index-list-image"></div>'),d=$("<img>"),h=$('<div class="index-list-main-text"></div>'),u=$('<div class="list-title"></div>'),p=$('<div class="list-bottom"></div>'),f=$('<b class="tip-time"></b>'),v=$('<b class="tip-hot"></b>'),w=$('<div class="list-album-container"></div>');$("#newslist-container").append(i),i.append(l),u.html(t),0==r?(l.addClass("showleft"),l.append(c),l.append(h),c.append(d),d.attr("src",s[0]),h.append(u),h.append(p)):1==r?(l.append(u),l.append(w),l.append(p),$.each(s,function(e,t){var n=$("<img>"),a=$('<div class="list-album-item"></div>');n.attr("src",s[e]),a.append(n),w.append(a)})):(l.append(u),l.append(p)),p.append(f),f.html(n),p.append(v),v.html(a)}function createScrollNews(e){var t=$('<div class="hot-news-icon"></div>'),s=$("<span>热点</span>"),n=$('<div class="hot-news-wrapper"></div>'),a=$('<ul class="hot-news-content"></ul>');t.append(s),n.append(a),$(".hot-scroll-news").append(t).append(n),$.each(e,function(t,s){var n=$("<li></li>"),o=$("<a></a>");n.append(o.attr("href",e[t].hotsrc).text(e[t].hottitle)),a.append(n)})}function scrollHot(){function e(e,t,s){if(e.transform||(e.transform={}),!(arguments.length>2))return void 0===(s=e.transform[t])&&(s=0),s;var n=null;e.transform[t]=s;for(var a in e.transform)n=a+"("+e.transform[a]+"px)",e.style.transform=n,e.style.WebkitTransform=n}var t=$(".hot-news-content")[0],s=0,n=0;e(t,"translateY",0);setInterval(function(){n=e(t,"translateY"),s-=19,n<=-96?(t.style.transition="none",e(t,"translateY",0),s=0):(t.style.transition="1s",e(t,"translateY",s))},3e3)}function compare(e){return function(t,s){return t[e]-s[e]}}function getBigHeight(e){function t(e,t){return e-t}for(var s=[],n=0;n<e.length;n++)s.push(e.eq(n).height());return s.sort(t)[0]}refresh("推荐");var scrollTouch=null,finished=!0,newsType=null,page=1;getMenus().then(function(e){var t=e.sort(compare("listindex"));return $.each(t,function(e,s){var n=$("<li></li>"),a=$("<a></a>");n.append(a),$("#allMenus").append(n),$("#allMenus a").eq(e+1).attr("href",t[e].listsrc),$("#allMenus a").eq(e+1).html(t[e].listvalue)}),calculatedMenusSize()}).then(function(){$(".scrollNavWrap").append('<ul class="scrollNav" id="scrollMenus"></ul>'),$("#allMenus").children().clone().appendTo($("#scrollMenus"));var e=$("body").width();$(".scrollNavWrap").css({width:e-$(".show-more").width()}),$("#scrollMenus").css({width:function(){var e=0,t=$(this).children(),s=parseInt(t.eq(0).css("margin-right"));return t.each(function(){e+=$(this).width()}),e+=2*t.size()*s-s}}),Transform($("#scrollMenus")[0]),scrollTouch=new AlloyTouch({touch:".scrollNavWrap",vertical:!1,target:$("#scrollMenus")[0],property:"translateX",min:-$("#scrollMenus").width()-$(".nav-placeholder").width()+$(".scrollNavWrap").width(),max:0})}),$(".scrollNavWrap").on("touchstart","a",function(e){e.preventDefault(),$("#scrollMenus").children().children().removeClass("selected")}).on("touchend","a",function(e){e.preventDefault();var t=$(this).parent().index(),s=$("#scrollMenus"),n=$("body").width();if($(this).addClass("selected"),t>2&&t<s.children().size()-3){var a=s.offset().left;if($(this).offset().left>n/2){var o=parseInt($(this).offset().left-n/2+$(this).width()/2);scrollTouch.to(a-o,0)}else{var r=parseInt(n/2-$(this).offset().left-$(this).width()/2);scrollTouch.to(a+r,0)}}else if(t>=s.children().size()-3){for(var i=0,l=0,c=0,d=parseInt($(this).parent().css("margin-right")),h=0;h<3;h++)i+=s.children().eq(t+h).width();i+=5*d,c=$(".scrollNavWrap").width()-i,l=s.width()-i,scrollTouch.to(-l+c-25,0)}else t<=2&&scrollTouch.to(0,0);switchNews(newsType=$(this).html())}),$("#allMenus").on("touchstart",function(){$(this).children().children().removeClass("selected")}).on("touchend",function(e){var t=$(e.target).parent().index();$(e.target).addClass("selected"),$(".btnNavArea").hide(),$(".mark").hide(),$("#scrollMenus a").eq(t).trigger("touchstart").trigger("touchend")}),$(".m-nav .show-more").on("touchend",function(){$(".btnNavArea").show();var e=$("#allMenus").width();$("#allMenus li").each(function(){$(this).children().html().length>2?$(this).css({width:e/3}):$(this).css({width:e/6})}),$(".mark").show(),$(".mark").css({height:$(window).height()})}),$("#show-more-hide").on("touchend",function(){$(".btnNavArea").hide(),$(".mark").hide()}),$(window).on("scroll",function(){Math.ceil(document.body.scrollTop)>500?$(".back-to-top").show():$(".back-to-top").hide(),loadMore(newsType)}),$(".back-to-top").on("touchend",function(){document.body.scrollTop=0})});